---
title: "Optimal number of subsamples"
output: html_notebook
---


## Optimal number of subsamples

The answer depends on the ratio between `s2_s` and `s2_e`. Call this `k`.

The answer depends on the relative costs of sub-samples and eu's. Call this `c_s / c_e = c`.

Given a total cost `T`, we can solve for the number of eus and sub-samples:

$T = n_e * n_s * c_s + n_e * c_e$

ie: for each of the $n_e$ experimental units a fixed cost of $c_e$ plus, we have $n_s$ subsamples at a cost of $c_s$ per subsample. 

Given both `T` and `n_s`, we can solve for `n_e`:

$n_e = T/c_e * 1/(n_s*c + 1))$

The SEM^2 is $(s2_e + s2_s/n_s)/(n_e)$. We want to minimize this. We can replace $n_e$ with the above equation: 

SEM^2 = $1/T * (c_e + n_s*c_s) * (s^2_e + s^2_s/n_s)$. We can take the derivative with respect to $n_s$, and solve for the minimum 

The optimal number of subsamples to minimize SEM is then $\sqrt{1/c * k}$.


```{r}
library(cowplot)
library(ggplot2)
Cs = c(.25,1,4)
Ks = 2^seq(-3,3,by=1)
n_s = seq(1:20)

data = expand.grid(c = Cs, k = Ks)
data$s = with(data,sqrt(1/c*k))
data$c = as.factor(data$c)

ggplot(data,aes(x=k,y=s)) + 
    scale_x_log10(breaks = unique(data$k)) +
    geom_hline(yintercept = 1) +
    # geom_vline(xintercept = 1) +
    geom_line(aes(group = c,color = c)) + 
    guides(color = guide_legend(title=expression(paste(c,'=',frac(c[s],c[e]))))) +
    ylab('optimal subsamples per eu') +
    xlab(expression(paste(k,'=',frac(sigma[s]^2,sigma[e]^2)))) +
    annotate("text",x=.25,y=4,label="n[s]~'='~sqrt(frac(c[e],c[s])~frac(sigma[s]^2,sigma[e]^2))~'='~sqrt(k/c)",parse=T,size=5) + #
    background_grid(major = "xy", minor = "none") + theme_cowplot()
```
