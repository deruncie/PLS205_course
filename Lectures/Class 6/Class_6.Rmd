---
title: "Class 5"
output: html_notebook
---

## Potato yield experiment
```{r}
library(ggplot2)
library(cowplot)
# Data modified from http://nppga.org/crop_science/research_reports_82_2586490995.pdf - noise added below.
alpine_potato = read.csv('Alpine_Russet_yield.csv')
```


An experiment was run to evaluate effects of increased nitrogen fertilization on tuber yield of frying potatoes
  5 nitrogen regimes (applied to plots): 0, 90, 150, 210, 270 lbs / acre at emergence
  10 reps / treatment combination
  Response: total yield
```{r,fig.width = 10}
plot_grid(
ggplot(data.frame()) + geom_text(aes(x=-1,y=0,label = 'An experiment was run to evaluate effects\n of increased nitrogen fertilization\n on tuber yield of frying potatoes\n
  5 nitrogen regimes (applied to plots):\n 0, 90, 150, 210, 270 lbs / acre at emergence\n
  10 reps / treatment combination\n
  Response: total yield per plot'),hjust=0,size=5)  +
  theme(text = element_blank(),
        line = element_blank(),
        title = element_blank()) + xlim(c(-1,1)),
ggplot(alpine_potato,aes(x=Nitrogen,y=Yield,group = Nitrogen)) + geom_boxplot(position = position_identity()) + 
    scale_x_continuous(breaks = unique(alpine_potato$Nitrogen)))
```

## estimate treatment effects vs control
```{r}
library(emmeans)

model1 = lm(Yield ~ factor(Nitrogen),alpine_potato)
yield_means <- emmeans(model1,'Nitrogen')
differences <- contrast(yield_means,'trt.vs.ctrl')
summary(differences,infer = F,adjust = 'none')
```

## Dunnett biggest difference from control, tukey biggest pairwise difference
```{r}
library(emmeans)
nTrt = 5
n = 10
differences = c()
difference1 = c()
max_difference = c()
max_pairwise_difference = c()
data = data.frame(Treatment = gl(nTrt,n,labels = LETTERS[1:nTrt]))
for(i in 1:1000){
  data$y = rnorm(nrow(data),330,30)
  lm1 = lm(y~Treatment,data)
  diffs = summary(emmeans(lm1,pairwise~Treatment)$contrasts)$estimate
  differences = rbind(differences,data.frame(
                    difference1 = coef(lm1)[2],
                    max_vs_control = coef(lm1)[-1][order(-abs(coef(lm1)[-1]))[1]],  # extract the biggest treatment effect relative to control 
                    max_pairwise = diffs[order(-abs(diffs))[1]]
                ))
}
```

## hist of difference1
```{r}
library(ggplot2)
library(reshape2)
differences_tall = melt(differences)
ggplot(subset(differences_tall,variable == 'difference1'),aes(x=value)) + geom_histogram(aes(color = variable,fill = variable),alpha = 0.5,bins = 30) + xlim(c(-50,50))
```

## simulate data with no Nitrogen effect, test for differences from control
```{r, fig.width=10, fig.height= 5}
library(ggplot2)
library(emmeans)
library(cowplot)
nTrt = 5
n = 10
Treatments = factor(unique(alpine_potato$Nitrogen))
# set.seed(1)
# for(i in 1:6) {
data = data.frame(Treatment = gl(nTrt,n,labels = Treatments),y = rnorm(n*nTrt,330,50))
lm1 = lm(y~0+Treatment,data)
# differences = emmeans(lm1,trt.vs.ctrl~Treatment)
lsms_1 = emmeans(lm1,trt.vs.ctrl~Treatment)
CIs = data.frame(summary(lsms_1,infer=c(T,F),adjust = 'none')$contrast)

# data$Treatment = factor(data$Treatment,levels = levels(data$Treatment)[order(coef(lm1))])
CIs$contrast = factor(CIs$contrast,levels = CIs$contrast)#[order((CIs$estimate))])
p1 = ggplot(data,aes(x=Treatment,y=y)) + geom_boxplot()
p2 = ggplot(CIs,aes(x=contrast)) + geom_errorbar(aes(ymax = upper.CL,ymin = lower.CL)) + geom_hline(yintercept = 0)
print(plot_grid(p1,p2,ncol = 2))
# }
```

## 






















```{r}
ggplot(subset(differences_tall,variable != 'max_pairwise'),aes(x=value)) + geom_histogram(aes(color = variable,fill = variable),position = 'identity',alpha = .5) + xlim(c(-50,50))
```

##
```{r}
summary(emmeans(model1,trt.vs.ctrl~Nitrogen),infer = c(F,T))$contrasts
```
##
```{r}
ggplot(alpine_potato,aes(x=Nitrogen,y=Yield,group = Nitrogen)) + geom_boxplot(color = 'blue',position = position_identity()) + ggtitle('Alpine Russet')+
    scale_x_continuous(breaks = unique(potato_reps$Nitrogen)) + expand_limits(y=0)
```
##
```{r, fig.width=10, fig.height= 5}
library(ggplot2)
library(emmeans)
library(cowplot)
nTrt = 5
n = 10
Treatments = factor(unique(potato_reps$Nitrogen))
set.seed(1)
for(i in 1:6) {
data = data.frame(Treatment = gl(nTrt,n,labels = Treatments),y = rnorm(n*nTrt,330, 50))
lm1 = lm(y~0+Treatment,data)
# differences = emmeans(lm1,trt.vs.ctrl~Treatment)
lsms_1 = emmeans(lm1,pairwise~Treatment)
CIs = data.frame(summary(lsms_1,infer=c(T,F),adjust = 'none')$contrast)

# data$Treatment = factor(data$Treatment,levels = levels(data$Treatment)[order(coef(lm1))])
CIs$contrast = factor(CIs$contrast,levels = CIs$contrast[order((CIs$estimate))])
p1 = ggplot(data,aes(x=Treatment,y=y)) + geom_boxplot()
p2 = ggplot(CIs,aes(x=contrast)) + geom_errorbar(aes(ymax = upper.CL,ymin = lower.CL)) + geom_hline(yintercept = 0) + theme(axis.text.x = element_text(angle = 90))
print(plot_grid(p1,p2,ncol = 2))
}
```
##
```{r}
ggplot(differences_tall,aes(x=value)) + geom_histogram(aes(color = variable,fill = variable),position = 'identity',alpha = .3) #+ xlim(c(-50,50))
```

##
```{r}
library(ggplot2)
library(reshape)
differences_tall = melt(differences)
ggplot(differences_tall,aes(x=value)) + geom_density(aes(color = variable,fill = variable),position = 'identity',alpha = 0.5) + xlim(c(-50,50))
# ggplot(subset(differences_tall,variable != 'max_pairwise'),aes(x=value)) + geom_density(aes(color = variable,fill = variable),position = 'identity',alpha = 0.5) + xlim(c(-50,50))
# ggplot(subset(differences_tall,variable == 'difference1'),aes(x=value)) + geom_density(aes(color = variable,fill = variable),alpha = 0.5) + xlim(c(-50,50))
```
##
```{r}
summary(emmeans(model1,tukey~Nitrogen),infer = c(T,F))$contrasts
```

##
```{r}
tukey_letters = cld(emmeans(model1,tukey~Nitrogen),Letters = letters)
tukey_letters
```
```{r}
tukey_letters = data.frame(tukey_letters)
tukey_letters = tukey_letters[order(tukey_letters$Nitrogen),]
ggplot(tukey_letters,aes(x=Nitrogen)) + 
    geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL)) + 
    geom_point(aes(y=lsmean)) + 
    geom_text(aes(label = trimws(.group),y = max(upper.CL + 10)))
```

