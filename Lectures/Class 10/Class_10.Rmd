---
title: "Class 9"
author: "Daniel Runcie"
output: html_notebook
---
```{r echo = F,message=FALSE, warning=FALSE}
library(ggplot2)
library(cowplot)
library(emmeans)
```

## Transformations
```{r echo = F}
species_data = read.csv('Log_ex.csv')
species_data$Species = relevel(species_data$Species,2)
p1=ggplot(species_data,aes(x=Species,y=Mass)) + geom_boxplot(aes(color=Treatment))  + expand_limits(y=0) #+ facet_wrap(~Species,scale = 'free')
p1
ggplot(subset(species_data,Species != 'Sheep'),aes(x=Species,y=Mass)) + geom_boxplot(aes(color=Treatment))  + expand_limits(y=0) #+ facet_wrap(~Species,scale = 'free')
```
```{r}
lm_Species = lm(Mass~Treatment:Species,species_data)
par(mfrow=c(1,2))
plot(lm_Species,which = c(2,3))
```

```{r}
lm_logSpecies = lm(log(Mass)~Treatment:Species,species_data)
par(mfrow=c(1,2))
plot(lm_logSpecies,which = c(2,3))
```
```{r,fig.width=10,fig.height=4}
p2 = ggplot(species_data,aes(x=Species,y=log(Mass))) +xlab('') + geom_boxplot(aes(color=Treatment))
plot_grid(p1,p2)
```

```{r}
mass = seq(0,150,length=100)
plot(mass,log10(mass),type='l')
```


### Effects on transformed scale
```{r}
normal_means = emmeans(lm_Species,specs = c('Treatment'),by='Species')
vitamin_effects = contrast(normal_means,method = 'trt.vs.ctrl')
summary(vitamin_effects,infer=c(F,T))
```

```{r}
log_means = emmeans(lm_logSpecies,specs = c('Treatment'),by='Species')
vitamin_effects = contrast(log_means,method = 'trt.vs.ctrl')
summary(vitamin_effects,infer=c(F,T))
```


### De-transform means
```{r}
log_means = as.data.frame(log_means)
means = data.frame(Treatment = log_means$Treatment,
                   Species = log_means$Species,
                   De_transformed_mean = 2^log_means$emmean,
                   lower.CL = 2^log_means$lower.CL,
                   upper.CL = 2^log_means$upper.CL)
means
summary(normal_means,infer=c(T,F))
```
```{r}
log_means = emmeans(lm_logSpecies,specs = c('Treatment','Species'))
summary(log_means,infer=c(T,F),type = 'response')
```

## Sqrt transformation
Number of *lygus* bugs per 50 sweeps for 11 insecticide treatments
```{r echo = F}
bug_data = read.csv('Sqrt_ex.csv')
str(bug_data)
ggplot(bug_data,aes(x=Treatment,y=Count)) + geom_boxplot()
```


### Means vs standard deviations
```{r echo = F}
par(mar=c(6,6,3,1))
means = with(bug_data,aggregate(Count,list(Treatment),mean))$x
sds = with(bug_data,aggregate(Count,list(Treatment),sd))$x
ggplot(data.frame(means,sds),aes(x=means,y=sds)) + geom_point(size=2) + ylab(expression(s^2)) + xlab(expression(bar(y)[i])) 
```


### Model diagnostics
```{r echo = F}
count_model = lm(Count~Treatment,bug_data)
par(mfrow=c(1,2))
plot(count_model,which=2:3,main = 'Pre transformation')
```

```{r echo = F}
sqrt_count_model = lm(sqrt(Count+0.5)~Treatment,bug_data)
par(mfrow=c(1,2))
plot(sqrt_count_model,which=2:3,main = 'Post transformation')
```

### CLD original vs transformed
```{r echo = F, fig.height=3}
count_means = emmeans(count_model,specs = 'Treatment')
cld(count_means)
```

```{r echo = 4, fig.height=3}
sqrt_count_means = emmeans(sqrt_count_model,specs = 'Treatment')
cld(sqrt_count_means)
```



## Logit transformation
Number of lettuce seads germinating in samples of 50 across 24 treatments.
```{r echo = F}
par(mfrow=c(1,1))
seeds = read.csv('Perc_ex.csv')
seeds$Treatment = factor(seeds$Treatment)
boxplot(seeds$Germinated_seeds~seeds$Treatment)
```

### Means vs variances
```{r echo = F}
par(mar=c(6,6,3,1))
means = aggregate(Germinated_seeds~Treatment,seeds,mean)$Germinated_seeds
vars = aggregate(Germinated_seeds~Treatment,seeds,var)$Germinated_seeds
plot(means,vars,xlab = expression(bar(y)[i]),ylab = expression(s^2),cex.lab = 2)
```

### Model diagnostics
```{r echo = F}
seeds_model = lm(Germinated_seeds~Treatment,seeds)
par(mfrow=c(1,2))
plot(seeds_model,which=2:3,main = 'Pre transformation')
```

```{r echo = F}
logit_seeds_model = lm(logit(Germinated_seeds/50)~Treatment,seeds)
library(car)
par(mfrow=c(1,2))
plot(logit_seeds_model,which=2:3,main = 'Post transformation')
```

## Power transformation
```{r echo = F}
species_data = read.csv('Log_ex.csv')
```


### Transformation function
```{r echo = F}
library(car)
par(mfrow=c(1,1))
transform = powerTransform(lm_Species)
x = seq(min(species_data$Mass),max(species_data$Mass),length=100)
plot(x,bcPower(x,transform$lambda),'l',ylab = 'Transformed y',xlab = 'y')
lines(x,bcPower(x,0),col=2)
legend('bottomright',c('log',paste('power',signif(transform$lambda,3))),col=c(2,1),lty=1)
```


## Model diagnostics
```{r echo = F}
lm_power_mass = lm(bcnPower(Mass,transform$lambda,gamma=0)~Treatment:Species,species_data)
par(mfrow=c(1,2))
plot(lm_power_mass,which = c(2,3),main = 'Power transform')
```
