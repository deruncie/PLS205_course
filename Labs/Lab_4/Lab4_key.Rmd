---
title: "Lab 4. Modeling trends"
author: Daniel Runcie. Modified from labs designed by Iago Hale, Dario Cantu and Jorge
  Dubcovsky
output: 
 html_notebook:
    toc: true
    toc_float: true
---

Necessary packages:
```{r,warning=FALSE}
library(ggplot2)
library(emmeans)
```


# Analysis of data from multiple treatments
This lab will use the dataset presented in lecture:

An experiment was run to evaluate effects of increased nitrogen fertilization on tuber yield of Alpine Russet potatoes

- 5 nitrogen regimes: 0, 90, 150, 210, 270 lbs / acre at emergence
- 10 reps / treatment combination
- Response: total yield
  
  
## Load data and inspect
```{r}
alpine_potato = read.csv('Alpine_Russet_yield.csv')
str(alpine_potato)
```

## Design table

**Design**: Completely Randomized Design (CRD)

| Structure | Variable | Type        | # levels | Experimental Unit |
|-----------|----------|-------------|----------|-------------------|
| Treatment | Nitrogen | Categorical | 5        | Plot              |
| Design    | Plot     | Categorical | 50       |                   |
| Response  | Yield    | Numeric     | 50       |                   |

We have two choices for the **Type** column for Nitrogen - Numeric or Categorical. R will choose
Numeric by default, but the correct choice depends on your analysis goals.

We will start with analyzing the data with Nitrogen as a Categorical variable. To do this, we
will create a new variable called **NitrogenFactor**. It will contain the same information,
but will lead to a different analysis.
```{r}
alpine_potato$NitrogenFactor = as.factor(alpine_potato$Nitrogen)
str(alpine_potato)
```


### Plot the data
Since we don't have subsamples, plotting the data is similar to plotting for Lab 2. 
We don't have to worry about estimating the experimental units like we did in Lab 3.
```{r}
library(ggplot2)
ggplot(alpine_potato,aes(x=Nitrogen)) + 
    geom_boxplot(aes(y=Yield,group = Nitrogen),color = 'blue',position = position_identity()) + 
  # note: when x is a continuous variable, we must use 'group' to get boxes
    ggtitle('Alpine Russet') + expand_limits(y=0) 
```


## Analysis as Factors
By now, you should be comfortable analyzing this the data from this experiment. You should be able to:

1. Write a model for the data, treating `Nitrogen` as a Categorical variable (ie a **Factor**) 
2. Run diagnostic tests
3. Form confidence intervals for comparisons among all pairs of treatments, or each treatment vs the control

Before continuing, ensure you can answer these questions:

> Are linear model assumptions satisfied for these data?
> Can you identify any pairs of treatments that differ. Which test will you use?

**Answer**: The assumptions appear satisfied. No clear problems in any diagnostics
**Answer**: Use the `pairwise` contrast for Tukey test

The code below will perform these analyses:

### Fit Factor model
```{r}
factor_model <- lm(Yield ~ NitrogenFactor, alpine_potato)
```

### Run diagnostics
```{r}
par(mfrow=c(1,2))
plot(factor_model,which=2:3)
```

### Form confidence intervals on differences
```{r}
library(emmeans)
factor_means <- emmeans(factor_model,specs='NitrogenFactor')
factor_differences <- contrast(factor_means,method='pairwise')
summary(factor_differences,level = 0.9, infer=T)
```

> Questions:
> 
> Can you say if any of the +N treatments increased yield relative to N=0? Which? Is this the correct test for this question?
> Can you distinguish any of the +N treatments? Which?

For the first question, this could be the correct test if you also were interested in the 2nd. 
But if your interest was actually only in comparisons to the control, you would have more power if you use the 'trt.vs.ctrl' (Dunnett) test.


### Run an ANOVA
In class, we discussed the difference between the Tukey method and ANOVA.

Tukey allows you to test all pairs of treatments to identify which are different. Here, this involves 10 questions.

ANOVA allows you to ask the single question: Are any treatments different?

You can run an ANOVA like this:
```{r}
anova(factor_model)
```

From this output, check the following:

> Why is Df for Nitrogen equal to 4?
> Is MST = SST/DfT? Is MSE = SSE/DfE? Is F = MST/MSE?  **Yes**: 92042/4=23010.5, 74664/45=1659.2, 23010.6/1659.2=13.868
> Is there evidence that any of the treatments are different? **Yes**: p-value is very small
> Can you identify which treatments differ? **No**. You need to use contrast() to figure this out 

From the Tukey output, we see that there is strong evidence that at least a few pairs of treatments
differ. The p-values are truncated in the output, but we can extract the smallest p-value like this:
```{r}
all_contrasts_data <- as.data.frame(factor_differences)
min(all_contrasts_data$p.value)
```
> Notice that this is very similar to the p-value of the ANOVA. Why is this?

**Answer**: The ANOVA asks a very similar question to the Tukey-corrected pairwise comparisons. 
"Is there any variation among treatment means" is very similar to "Do any pairs of treatments differ"?
Clearly if the answer to the second is different, the answer to the first should be as well.

-------------------------------------------------------------------------------------

## Analysis as Trend
The above analysis is not very satisfying for this experiment. We can identify that adding Nitrogen
tends to increase yield, but how much is best? We have little ability using Tukey to say which
level is best. We also can't say anything about possible Nitrogen application rates between say 90lbs and 150lbs.

The goals of a trend analysis are to create a model that predicts the response (Yield) for any
value of Nitrogen application. In building a model, we will have to worry about both bias and precision.
The general strategy will be:

1) Fit a fully-parameterized trend model
2) Use ANOVA to test if a reduced (ie more parsimonious) model will be sufficient
3) Use the model to generate predictions and confidence intervals for yield at specific Nitrogen levels


### Fit a trend model
To fit a fully-parameterized trend model, do this:
```{r}
full_trend <- lm(Yield ~ I(Nitrogen) + I(Nitrogen^2) + I(Nitrogen^3) + I(Nitrogen^4),alpine_potato)
```

**Note 1:** here we use `Nitrogen` (the Numeric variable) instead of `NitrogenFactor`

**Note 2:** to raise the value of `Nitrogen` to a power, you have to enclose it in the `I()` function. 

**Note 3:** See below for a faster way of writing this model

### Use ANOVA to try to reduce the model
We can evaluate the fit by looking at an ANOVA table
```{r}
anova(full_trend)
```

> Questions
>
> Compare the ANOVA to the ANOVA from the factor model. What is different? What is the same?
> If you were to make diagnostic plots, how would they compare to the factor_model above? Why?

**Answer**: The 'Residuals' row is the same (DfE, SSE, MSD). 
The treatment rows are expanded and split apart here. In this case, SST from the Factor ANOVA is equal to the sum of the for SST here.
MST is different because the ratio is broken into several different ratios.
The diagnostic plot only looks at the residuals, so will be identical.


**Note**: When evaluating linear model assumptions in a trend analysis, evaluate them BOTH for the
fully-specified model and for the reduced model if you choose a reduce model.

We evaluate the model by inspecting the `Sum Sq` and `Pr(>F)` columns. Starting from the highest-order
term of the polynomial, we inspect it's SST and p-value. If the p-value is small, this means that there
is evidence in the data that this term is important. If the SST is large, it means that this term explains 
a large amount of the variance (ie sums of squared differences) of the observations. We should use
both of these to decide if the term can be dropped.

> Here, the N^4 term is border-line important. 
> It explains some variance, but not nearly as much as the order 1 and 2 terms.
> The N^3 term is clearly unimportant. But we can't drop it unless we drop N^4 as well.
> The N^2 term is very important. We will definitely keep this term (and so also N^1)

We will compare both the degree-2 and degree-4 models below.

**Note**: If we select the degree-4 model, it means that we **cannot** safetly make predictions
at new levels of Nitrogen. We'd need a new experiment!

### Create plots of the model fits
It can also be helpful to actually visualize the trend fits.

**The code below is difficult. Use it as a template for other assignments.**

We first create a new data tables to hold the predicted values for each model.
We then use `emmeans` to predict the Yield at each intermediate value of Nitrogen.

```{r}
# Create a new data.frame with the set of Nitrogen values we want to plot the trends
predicted_data <- data.frame(Nitrogen = seq(0,300,length=100)) 
```

Get predicted values for the full model using `emmeans()` and append the values to the data.frame
```{r}
full_trend_means = emmeans(full_trend,spec = 'Nitrogen',at=list(Nitrogen = predicted_data$Nitrogen))
predicted_data$full_trend = as.data.frame(full_trend_means)$emmean
```

Now, we fit a reduced model with only degree=2, and get predicted yields with `emmeans()` and append these values to the data.frame
```{r}
reduced_trend <- lm(Yield ~ I(Nitrogen) + I(Nitrogen^2),alpine_potato)
reduced_trend_means = emmeans(reduced_trend,spec = 'Nitrogen',at=list(Nitrogen = predicted_data$Nitrogen))
predicted_data$reduced_trend = as.data.frame(reduced_trend_means)$emmean
```


Now, we can add these trends to our plot of the data
```{r}
ggplot(alpine_potato,aes(x=Nitrogen)) + 
    geom_boxplot(aes(y=Yield,group = Nitrogen),color = 'blue',position = position_identity()) + 
    ggtitle('Alpine Russet') + expand_limits(y=0) + 
    geom_line(data = predicted_data,aes(y=full_trend,color = 'full'),size=1.5) + 
    geom_line(data = predicted_data,aes(y=reduced_trend,color = 'reduced'),size=1.5) 
```

> Questions
>
> Evaluate the differences in bias between the two models. 
> Are either consistently biased? 
> Are they biased at particular levels of Nitrogen?

**Answer**: The full model is not biased. It's estimate goes through the center of the observations for every observed level of N/
The reduced model is biased at several levels of Nitrogen. It is biased-low at 150 and biased-high at 90.

### Creating predictions at particular values of Nitrogen
We can use a trend model to predict responses at intermediate values between our treatments.

For a prediction, we want to be able to provide:

1. a best-guess value
2. A confidence interval

As always, the confidence intervals is estimate +/- critical_value * SE_hat

- The estimate will come from the **explanatory component** of the model
- The critical value will come from a t-distribution. We don't need to adjust for multiple comparisons
because we are only making a single prediction.
- The estimated standard error will depend on both MSE and sample size. We can let the `predict` function calculate this

Let's make a confidence interval for Nitrogen = 120lbs for the reduced model.
We can use the `emmeans` function for this. 
We specify that we are predicting across Nitrogen levels, and then use `at = list(Nitrogen = 120)` to
specify that we want an estimate and confidence interval at 120lbs.
```{r}
reduced_trend_means = emmeans(reduced_trend,'Nitrogen',at=list(Nitrogen = 120))
summary(reduced_trend_means,level = 0.8,infer = c(T,F))
```

> You should be able to calculate these confidence intervals yourself, taking the estimate ('emmean'), SE and df from above.
Do so here:

```{r}
447.7925 + 8.969197 * qt(0.2/2,47,lower.tail=F)
447.7925 - 8.969197 * qt(0.2/2,47,lower.tail=F)
```

Similarly, we can predict the effect of a new level of Nitrogen relative to Nitrogen = 0
```{r}
reduced_trend_means = emmeans(reduced_trend,'Nitrogen',at=list(Nitrogen = c(90,50,100,130)))
reduced_trend_effects = contrast(reduced_trend_means,'trt.vs.ctrl',ref=1)
summary(reduced_trend_effects,level = 0.9,infer = c(T,F))
```



### Plotting prediction intervals
It is often helpful to plot prediction intervals around the whole trend. The following code
will do this for the reduced model
```{r}
# The output of emmeans can be converted to a data.frame to extract both the estimate (emmean) and the bounds of the CI
reduced_trend_means = emmeans(reduced_trend,'Nitrogen',at=list(Nitrogen = seq(0,300,length=100)))
predicted_data <- as.data.frame(summary(reduced_trend_means,level = 0.95))

ggplot(alpine_potato,aes(x=Nitrogen)) + 
    geom_boxplot(aes(y=Yield,group = Nitrogen),color = 'blue',position = position_identity()) + 
    ggtitle('Degree-2 trend') + expand_limits(y=0) +
    geom_ribbon(data=predicted_data,aes(ymin = lower.CL,ymax=upper.CL),color=0,alpha=0.3)  + # add confidence bounds
    geom_line(data=predicted_data,aes(y=emmean),size=1.5)
```

Even though it's not safe to use the intervals from the full_model, we can still plot them for comparison
```{r}
full_trend_means = emmeans(full_trend,'Nitrogen',at=list(Nitrogen = seq(0,300,length=100)))  # use the `full_trend` model instead of the `reduced_trend` model
predicted_data <- as.data.frame(summary(full_trend_means,level = 0.95))


ggplot(alpine_potato,aes(x=Nitrogen)) + 
    geom_boxplot(aes(y=Yield,group = Nitrogen),color = 'blue',position = position_identity()) + 
    ggtitle('Degree-4 trend') + expand_limits(y=0) +
    geom_ribbon(data=predicted_data,aes(ymin = lower.CL,ymax=upper.CL),color=0,alpha=0.3)  + # add confidence bounds
    geom_line(data=predicted_data,aes(y=emmean),size=1.5)
```

> Questions
>
> Compare the predictions and prediction intervals for the full and reduced model
>
> How biased is the reduced model?
> Which model has narrower prediction intervals?
> Why isn't the width of the prediction intervals constant? What must be changing in the formula
for a confidence interval?
> Which model do you prefer?

What changes is the SE. The DfE is staying the same.
I prefer the degree-2 model.

-------------------------------------------------------------------------------------

## Short-cut for modeling trends.
R includes many shortcuts for writing models. As models get more compicated, these can
help make your code easier to read.

A short-cut for writing **polynomial-trend** models is the function **poly**
```{r}
full_trend_short <- lm(Yield ~ poly(Nitrogen,4),alpine_potato)
```


### ANOVA table for poly() model
This model is equivalent to the one we used above (`full_trend`) - it fits a degree-4 polynomial.
However, due to some quirks with R, the `anova()` function won't give a full anova table for
this model. Instead, to evaluate the importance of each of the terms, use the `summary` function
```{r}
summary(full_trend_short)
```

Compare this to `anova` on `full_trend`
```{r}
anova(full_trend)
```

Things to note:

1. The p-values for each term are exactly the same.
2. Summary gives Residual standard error: 40.73. This is equal to sqrt(MSE) from `anova`. 
The degrees of freedom for Residuals is also the same.
3. Instead of `Sum Sq`, we get `Estimate`. `Estimate^2` is equal to `Sum Sq`. 
This is like the difference between `t` and `F`.
