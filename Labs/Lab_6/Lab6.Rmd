---
title: "Lab 6. Factorial Experiments"
author: Daniel Runcie. Modified from labs designed by Iago Hale, Dario Cantu and Jorge
  Dubcovsky
output: 
 html_notebook:
    toc: true
    toc_float: true
---

**This needs to be fixed for next year. Don't rbind tests together across b=Variety. Instead, adjust level = 1-alpha/k**


Necessary packages:
```{r}
library(ggplot2)
library(emmeans)
library(multcomp)
```


This lab will explore techniques for analyzing factorial experiments - experiments with at least two
classes of treatments that are tested in all combinations. 

We will work from the dataset described in lecture: :

An experiment was run to evaluate effects of increased nitrogen fertilization on tuber yield of Alpine Russet potatoes

- 5 nitrogen regimes: 0, 90, 150, 210, 270 lbs / acre at emergence
- 2 varieties: Alpine Russet (Alpine) and Russet Burbank (Burbank)
- 10 reps / treatment combination
- Response: total yield
  
## Load data and inspect
```{r}
potato_data = read.csv('Potato_yield.csv')
str(potato_data)
```

### Design Table
For this lab, we'll treat Nitrogen as a factor. We won't worry about analyzing the trend itself.

**Design**: Completely Randomized Design

| Structure | Variable  | Type        | # levels | Experimental Unit |
|-----------|-----------|-------------|----------|-------------------|
| Treatment | NitrogenF | Categorical | 5        | Plot              |
|           | Variety   | Categorical | 2        | Plot              |
|           | Var:N     | Categorical | 10       | Plot              |
| Design    | Plot      | Categorical | 100      |                   |
| Response  | Yield     | Numeric     | 100      |                   |


### Checking data

Note that we need to change the **Nitrogen** variable in our data.frame to a categorical variable (ie Factor).
I'll create a new variable called **NitrogenF** rather than over-writing the `Nitrogen` variable. After
this change, I went back to the Design table above and corrected the Variable name.
```{r}
potato_data$NitrogenF = as.factor(potato_data$Nitrogen)
str(potato_data)
```

Our design table listed a new variable **Var:N**. This interaction is part of our treatment design
because the experiment is a factorial. In our design table, we wrote that there should be 10
levels of this variable. How can we check this in our data?

To check, we can create a new variable, say called **Var_N** (the ':' character doesn't work well for variable names) like this:
```{r}
potato_data$Var_N = interaction(potato_data$Nitrogen,potato_data$Variety,drop=TRUE)
# the argument drop=TRUE means that if our experiment is not a full factorial and some combinations of 
# treatments are missing, we won't create a level for those missing combinations.
# This makes it easier to count the actual number of levels
str(potato_data)
```
Note that the new variable **Var_N** has 10 levels.

We can check using this code:
```{r}
# this counts the number of unique levels of the variable Var_N in the data
length(unique(potato_data$Var_N))
```



--------------------------------------------------------------------------------------------

## Analysis of a factorial

Our main goal with a factorial experiment is to identify and characterize **interactions** between 
the different treatments.

We may also what to answer the questions:

- Is there any evidence of a difference between the varieties?
- Is there any evidence of an effect of Nitrogen?


As before, we will follow the following steps in our analysis:

1. Fit a linear model to the data
2. Assess the linear model assumptions using plots
3. Perform hypothesis tests or extract estimates of treatment effects



### Linear model for factorial experiments

As specified in our **Design Table**, we have three explanatory variables in our model. We specify
the model like this:

```{r}
potato_factorial <- lm(Yield ~ NitrogenF + Variety + NitrogenF:Variety, data = potato_data)
```

> The symbol ':' tells R to form all combinations of the variables **NitrogenF** and **Variety**,
> just like we did manually above using the `interaction()` function. We could directly put in our
> variable **Var_N** into the model instead, and we'd get exactly the same model. However, tools like
> `emmeans` can parse a model written as above to pull out specific effects, so we will generally
> form the factor combinations directly in the model statement.

We interpret this model statement as saying we want:

- an effect due to **differences** among the levels of NitrogenF
- an additional effect due to **differences** between the Varieties
- an **additional effect** due to specific combinations of NitrogenF and Varieties.


### Checking model assumptions

The same plots are useful to check model assumptions
```{r}
par(mfrow=c(1,2))
plot(potato_factorial,which=2:3)
```

These plots look very good - no evidence of departures from normality, or different variances among groups
with larger vs smaller average yields.


### ANOVA
An ANOVA is useful as a test of the null-hypothesis that there is no interaction between Nitrogen
and Variety, or that there is no effect at all of either Nitrogen or Variety.

```{r}
anova(potato_factorial)
```

### Questions:

> Do the DF's match up with what you expect? Why is the DfI = 4? How is DfE calculated?
> How important is the interaction between Nitrogen and Variety?
> Does this match up with your observation from the interaction plot?
> Is there strong evidence that both Nitrogen and Variety impact yields?

#### Interpreting the Factorial ANOVA

As we saw with the trend models last week, the `anova` function will produce a row for 
each of the terms that we entered into our model. The table is interpreted sequentially
from the bottom up. The `Sum Sq` of Residuals is used to calculate MSE. The `Sum Sq` for
NitrogenF:Variety is the amount of variation that is explained by **interactions**, ie changes in the
effect of one factor when the other factor is changed. `SSI` is calculated by R by comparing the MSE
of models with and without this interaction term.

To test the null hypothesis of no interaction (ie that the difference between varieties is constant
regardless of the amount of Nitrogen), we simply look at the p-value for the NitrogenF:Variety term.
The p-value is the chance of seeing MSI this large (given MSI), if there was no interaction. We can declare 
the interaction significant if this p < alpha. This test will have a Type-I error rate of alpha.

We can also assess the importance of the interactions by comparing MSI to the MST's. Here, there
is **strong evidence** of an interaction (note I'm not saying it's significant!). But the importance 
of the interaction is not very large relative to the Variety-MST. This suggests that the interactions
don't change the general conclusion of a difference among the Varieties.

**Say we did not observe strong evidence of an interaction?** We might still be interested in whether 
there is any evidence of an effect of Nitrogen or Variety at all. 

> Note: If the interaction is important, this by definition means that both Nitrogen and Variety are
important, at least in some conditions! If you get this result, then the answer to the above question is clearly YES

If the p-value for the interaction is large, but the p-value for a **Main Effect** is small, we'd conclude that
there is an effect of that treatment. However, now, we've looked at **3 p-values** to make this conclusion!. That
means that we have 3 changes to make a false-positive statement! So at this point, we'd want to do a Bonferroni correction 
to the p-values of NitrogenF and Variety before drawing conclusions. With 3 tests, we'd multiply each p-value by 3. 
(Equivalently, for hypothesis testing, we would compare each p-value to alpha/3)

### Inspecting interactions
The ANOVA is a quick test of the overall importance of interactions. But it's rarelly sufficient to
describe results. Generally, we want to be able to report on the size of effects, and provide confidence intervals.

The strategy is the following:

1. If the interactions are important, report **specific effects** of each treatment.
2. If the interactions are not important, report a single **main effect** for each treatment

The logic is that if the differences among Varieties (or Nitrogen levels) changes depending on Nitrogen rate,
than any single estimate of a Variety effect will be wrong as soon as you change Nitrogen. But if there is 
not interaction, than the average Variety effect over the whole experiment will be your best bet (and have the smallest confidence interval).

#### Calculating specific effects
Since we observed an interaction above, let's calculate the effect of changing from Alpine to Burbank 
at each of the 5 levels of Nitrogen. 
We use `emmeans`, ask for means for each Variety (with `specs`), and tell it to calculate the means separately for each level of Nitrogen
with the `by='NitrogenF'` command:
```{r}
specific_means <- emmeans(potato_factorial,specs = c('Variety','NitrogenF'))
variety_effects = contrast(specific_means,method = 'pairwise',by = 'NitrogenF')
summary(variety_effects,infer=T)
```

As expected, these effects depending on NitrogenF. `emmeans` provides confidence intervals for **each** specific effect.
**However**, these intervals are **not simultaneous** - each is has a level of 0.95. If we want all 5 intervals to be 
safe, we should do a bonferroni correction by changing the level (to 1-0.05/5 = 0.99). Fortunately, `emmeans` 
provides a quick way to do this for you:
```{r}
collected_variety_effects <- rbind(variety_effects) 
# rbind concatenates each estimate together into a single table, and then 
# makes all intervals simultaneous.
summary(collected_variety_effects,infer=T)
```


> **Activity:** Repeat this analysis, but calculate the specific effects of NitrogenF for each Variety
> For this, calculate the specific effects as effects of adding an particular amount of Nitrogen relative to the control Nitrogen=0

```{r}
N_effects = contrast(specific_means,method='trt.vs.ctrl',by='Variety')
summary(N_effects,infer = T)
```

#### Comparing simple effects
So no we have estimates of the specific effects of Variety (or Nitrogen). However, it might be
nice to be able to identify which specific effects differ from each other. An interaction
means that not all of the Variety differences are the same. **Which ones are distinguishable?**

This sounds like a question of pairwise comparisons! 
We'll need to calculate the **differences** between the **variety effects** at each level of Nitrogen.

The `collected_variety_effects` object above holds each of these variety effects.

The `pairs` function will compare these effects in a pairwise fashion and applies a Tukey-correction!
```{r}
pairs(collected_variety_effects)
```

The contrast describes the comparison. For example, the first line represents the difference between
the Variety effect (Alpine-Burbank) at N=0 vs the Variety effect at N=90.

> Scanning through this, can you identify any pairs of variety effects that are different?

As with the pairwise comparisons earlier, the Compact Letter Display is a more concise method to display these results
```{r}
cld(collected_variety_effects)
```


### Visualizing interactions
Using the fitted model, we can plot the interactions and confidence intervals

One method is the classic **Interaction Plot** as we made above, where we connect the group means for Variety
across levels of Nitrogen

```{r}
ggplot(as.data.frame(specific_means),aes(x=NitrogenF,y=emmean,group=Variety)) + 
  geom_ribbon(aes(ymin = lower.CL,ymax=upper.CL),alpha = 0.3) + # add a shaded area of the confidence intervals
  geom_line(aes(y=emmean,color=Variety)) + # add a line through the treatment means
  geom_point(aes(y=emmean,color=Variety)) # add a point at each treatment mean
```

> We look for evidence of non-parallel lines.

The above plot is nice because it shows the results on the scale of the data. However, we can also 
directly plot the interaction (or the Variety effects)

```{r}
# get confidence intervals
summary_collected_variety_effects = summary(collected_variety_effects,infer=T)
summary_collected_variety_effects
```
```{r}
# make plots
ggplot(as.data.frame(summary_collected_variety_effects),aes(x=factor(as.numeric(as.character(NitrogenF))),y=estimate,group=1)) +
  geom_ribbon(aes(ymin = lower.CL,ymax = upper.CL),alpha = 0.2) + 
  geom_line() + geom_point() +
  geom_hline(yintercept = 0) # lets add a y=0 line
```

From this we can see where the variety effects are significantly non-zero.

> **Question**: What would this graph look like if there were no interaction?

Once again, the emmeans package can actually do our work for us. It has it's own `plot()` function 
that can be used on both outputs of `emmeans()` and `contras()`:
```{r}
plot(collected_variety_effects,horizontal = F)
```

To view the help page for this plot function, do: `?plot.emmGrid`. There you can see some options. Explore:

- `type`: just like for transformed data, can do `type = 'response'` to get de-transformed estimates. 
Only use for treatment means, not treatment differences
- `comparisons`: adds arrows that give an impression for which groups are significantly different.


### Extracting main effects
Say we decided that the interactions were not important. We would then want to report
only a single estimate of the Variety (or NitrogenF) effects. 
We can do that with `emmeans` by re-runing without `by='NitrogenF')
```{r}
variety_main_effect <- emmeans(potato_factorial, specs = 'Variety')
variety_main_effect_differences <- contrast(variety_main_effect,method='pairwise')
summary(variety_main_effect_differences,infer=T)
```

We could do the same for the NitrogenF main effects:
```{r}
Nitrogen_main_effect <- emmeans(potato_factorial, specs = 'NitrogenF')
Nitrogen_main_effect_differences <- contrast(Nitrogen_main_effect,method='trt.vs.ctrl')
summary(Nitrogen_main_effect_differences,infer=T)
```

--------------------------------------------------------------------------------------------

## Short-cuts for model specification
R has lots of short-cuts to help write complex models more clearly. For factorials,
these three models are equivalent:
```{r}
potato_factorial <- lm(Yield ~ NitrogenF + Variety + NitrogenF:Variety,potato_data)
potato_factorial <- lm(Yield ~ NitrogenF*Variety,potato_data)
potato_factorial <- lm(Yield ~ (NitrogenF+Variety)^2,potato_data)
```

- The '*' character tells R you want both factors individually, plus their combinations.
- The ^2 symbol tells R you want all the factors inside the parantheses, plus their two-way combinations.
With more factors, you could have 3-way, 4-way, etc combinations too.!



## Visualizing interactions before analysis

Even before running formal statistical tests, it can be useful to visualize your data, and inspect for 
evidence of interactions. 

The `ggplot` function excels at plots for visualizing interactions between two variables.

This code makes a jitter-plot of the data:
```{r}
ggplot(potato_data) + geom_jitter(aes(x=NitrogenF,y=Yield,color=Variety),width=.1)
```

This code adds lines between the treatment means. This is the classic interaction plot where non-parallel lines
are evidence of an interaction
```{r}
ggplot(potato_data,aes(x=NitrogenF,y=Yield,color=Variety)) + geom_jitter(width=.05) + 
  stat_summary(aes(group = Variety),fun.y = mean,geom = 'line')  # we summarize the groups by the mean, and connect with a line
```

We can also flip the graph over to ask if the effect of NitrogenF changes by Variety

```{r}
ggplot(potato_data,aes(x=Variety,y=Yield,color=NitrogenF)) + geom_jitter(width=.05) + 
  stat_summary(aes(group = NitrogenF),fun.y = mean,geom = 'line')
```

> Here, the lines look mostly parallel except for the 270lbs Nitrogen line


These plots are good for quick visual inspections of the data. But ultimately you will want to do the full analyses above to get confidence intervals and select which contrasts to report.



